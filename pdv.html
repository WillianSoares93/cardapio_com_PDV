<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV - Sâmia Pizzaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/catalogo_pizzaria/refs/heads/main/logo.png" type="image/png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body {
            font-family: 'Roboto', sans-serif;
            visibility: hidden;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
        #pdv-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 999;
            display: none;
        }
        .details-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .order-card.expanded .details-container {
            max-height: 1500px;
        }
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4ade80;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4ade80;
        }
        .status-filter-btn.active {
            background-color: #2563eb;
            color: white;
        }
        .main-tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .main-tab-btn.active {
            border-bottom-color: #ef4444; /* red-500 */
            color: #ef4444;
            background-color: #fef2f2; /* red-50 */
        }
        .mesa-item {
            transition: all 0.2s ease-in-out;
            aspect-ratio: 1 / 1;
        }
        .mesa-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .mesa-status-livre { background-color: #dcfce7; border-color: #22c55e; color: #166534; }
        .mesa-status-ocupada { background-color: #fee2e2; border-color: #ef4444; color: #991b1b; }
        .mesa-status-conta { background-color: #fef9c3; border-color: #facc15; color: #854d0e; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="pdv-overlay"></div>

    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Painel de Pedidos - Sâmia Pizzaria</h1>
            <div class="flex items-center space-x-2">
                <a href="atendente.html" target="_blank" class="px-3 py-2 bg-purple-600 text-white text-xs font-bold rounded-md hover:bg-purple-700">Lançar Pedido</a>
                <button id="close-cash-register-btn" class="px-3 py-2 bg-green-600 text-white text-xs font-bold rounded-md hover:bg-green-700">Fechar Caixa</button>
                <button id="manage-menu-btn" class="px-3 py-2 bg-blue-600 text-white text-xs font-bold rounded-md hover:bg-blue-700">Gerenciar Cardápio</button>
                <button id="clear-finished-btn" class="px-3 py-2 bg-gray-600 text-white text-xs font-bold rounded-md hover:bg-gray-700">Limpar Finalizados</button>
                <button id="logout-btn" class="px-3 py-2 bg-red-600 text-white text-xs font-bold rounded-md hover:bg-red-700">Sair</button>
                <div id="connection-status" class="text-sm font-medium text-gray-500">
                    <i class="fas fa-circle text-red-500 mr-2"></i>Conectando...
                </div>
            </div>
        </div>
    </header>

    <div class="bg-gray-800 text-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center py-4">
                <div><h3 class="text-sm font-medium text-gray-400">PEDIDOS HOJE</h3><p id="stats-total-orders" class="text-2xl font-bold">0</p></div>
                <div><h3 class="text-sm font-medium text-gray-400">FATURAMENTO TOTAL</h3><p id="stats-total-revenue" class="text-2xl font-bold">R$ 0,00</p></div>
                <div><h3 class="text-sm font-medium text-gray-400">TICKET MÉDIO</h3><p id="stats-avg-ticket" class="text-2xl font-bold">R$ 0,00</p></div>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Abas Principais -->
        <div class="border-b border-gray-200 bg-white rounded-t-lg shadow-sm">
            <nav id="main-tabs" class="flex -mb-px" aria-label="Tabs">
                <button class="main-tab-btn active w-1/3 py-4 px-1 text-center border-b-4 font-medium text-lg" data-tab="delivery">
                    <i class="fas fa-motorcycle mr-2"></i> Delivery
                </button>
                <button class="main-tab-btn w-1/3 py-4 px-1 text-center border-b-4 border-transparent text-gray-500 hover:text-gray-700 font-medium text-lg" data-tab="retirada">
                    <i class="fas fa-shopping-bag mr-2"></i> Retirada
                </button>
                <button class="main-tab-btn w-1/3 py-4 px-1 text-center border-b-4 border-transparent text-gray-500 hover:text-gray-700 font-medium text-lg" data-tab="mesas">
                    <i class="fas fa-utensils mr-2"></i> Mesas
                </button>
            </nav>
        </div>

        <!-- Conteúdo das Abas -->
        <div id="tab-content-delivery" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-4">
                <div class="bg-red-50 rounded-lg shadow"><div class="p-4 border-b border-red-200"><h2 class="text-lg font-bold text-red-800">Novos Pedidos</h2></div><div id="col-delivery-novo" class="p-4 space-y-4 overflow-y-auto h-[calc(100vh-20rem)]"></div></div>
                <div class="bg-yellow-50 rounded-lg shadow"><div class="p-4 border-b border-yellow-200"><h2 class="text-lg font-bold text-yellow-800">Em Preparo</h2></div><div id="col-delivery-preparo" class="p-4 space-y-4 overflow-y-auto h-[calc(100vh-20rem)]"></div></div>
                <div class="bg-green-50 rounded-lg shadow"><div class="p-4 border-b border-green-200"><h2 class="text-lg font-bold text-green-800">Pronto para Entrega</h2></div><div id="col-delivery-entrega" class="p-4 space-y-4 overflow-y-auto h-[calc(100vh-20rem)]"></div></div>
                <div class="bg-gray-200 rounded-lg shadow"><div class="p-4 border-b border-gray-300"><h2 class="text-lg font-bold text-gray-800">Finalizados</h2></div><div id="col-delivery-finalizado" class="p-4 space-y-4 overflow-y-auto h-[calc(100vh-20rem)]"></div></div>
            </div>
        </div>

        <div id="tab-content-retirada" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-4">
                <div class="bg-red-50 rounded-lg shadow"><div class="p-4 border-b border-red-200"><h2 class="text-lg font-bold text-red-800">Aguardando Retirada</h2></div><div id="col-retirada-novo" class="p-4 space-y-4 overflow-y-auto h-[calc(100vh-20rem)]"></div></div>
                <div class="bg-yellow-50 rounded-lg shadow"><div class="p-4 border-b border-yellow-200"><h2 class="text-lg font-bold text-yellow-800">Em Preparo</h2></div><div id="col-retirada-preparo" class="p-4 space-y-4 overflow-y-auto h-[calc(100vh-20rem)]"></div></div>
                <div class="bg-green-50 rounded-lg shadow"><div class="p-4 border-b border-green-200"><h2 class="text-lg font-bold text-green-800">Pronto para Retirada</h2></div><div id="col-retirada-pronto" class="p-4 space-y-4 overflow-y-auto h-[calc(100vh-20rem)]"></div></div>
                <div class="bg-gray-200 rounded-lg shadow"><div class="p-4 border-b border-gray-300"><h2 class="text-lg font-bold text-gray-800">Finalizados</h2></div><div id="col-retirada-finalizado" class="p-4 space-y-4 overflow-y-auto h-[calc(100vh-20rem)]"></div></div>
            </div>
        </div>

        <div id="tab-content-mesas" class="tab-content hidden">
            <div id="mesas-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6 mt-4">
                <!-- As mesas serão inseridas aqui pelo JavaScript -->
            </div>
        </div>
    </main>

    <!-- Modais (Abrir/Fechar Caixa, Gerenciar Cardápio, Editar Pedido, etc. continuam aqui, sem alterações) -->
    <div id="open-cash-modal" class="modal">...</div>
    <div id="close-cash-modal" class="modal">...</div>
    <div id="menu-management-modal" class="modal">...</div>
    <div id="edit-order-modal" class="modal">...</div>
    <div id="delete-confirm-modal" class="modal">...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, getDoc, query, orderBy, where, writeBatch, setDoc, addDoc, serverTimestamp, getDocs, limit, Timestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBJ44RVDGhBIlQBTx-pyIUp47XDKzRXk84",
            authDomain: "pizzaria-pdv.firebaseapp.com",
            projectId: "pizzaria-pdv",
            storageBucket: "pizzaria-pdv.firebasestorage.app",
            messagingSenderId: "304171744691",
            appId: "1:304171744691:web:e54d7f9fe55c7a75485fc6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- LÓGICA DE AUTENTICAÇÃO E CAIXA (sem alterações) ---
        // ... (código existente)

        // --- INÍCIO DA REESTRUTURAÇÃO ---
        const mainTabs = document.getElementById('main-tabs');
        const tabContents = document.querySelectorAll('.tab-content');
        const mesasGrid = document.getElementById('mesas-grid');
        const NUMERO_DE_MESAS = 12;

        // Colunas para Delivery
        const colDeliveryNovo = document.getElementById('col-delivery-novo');
        const colDeliveryPreparo = document.getElementById('col-delivery-preparo');
        const colDeliveryEntrega = document.getElementById('col-delivery-entrega');
        const colDeliveryFinalizado = document.getElementById('col-delivery-finalizado');

        // Colunas para Retirada
        const colRetiradaNovo = document.getElementById('col-retirada-novo');
        const colRetiradaPreparo = document.getElementById('col-retirada-preparo');
        const colRetiradaPronto = document.getElementById('col-retirada-pronto');
        const colRetiradaFinalizado = document.getElementById('col-retirada-finalizado');
        
        // Lógica de troca de abas
        mainTabs.addEventListener('click', (e) => {
            const tabButton = e.target.closest('.main-tab-btn');
            if (!tabButton) return;

            mainTabs.querySelector('.active').classList.remove('active');
            tabButton.classList.add('active');

            tabContents.forEach(content => content.classList.add('hidden'));
            const tabName = tabButton.dataset.tab;
            document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');
        });

        // Inicializa as mesas
        function initializeMesas() {
            mesasGrid.innerHTML = '';
            for (let i = 1; i <= NUMERO_DE_MESAS; i++) {
                const mesaEl = document.createElement('div');
                mesaEl.id = `mesa-${i}`;
                mesaEl.className = 'mesa-item flex flex-col justify-center items-center p-4 border-2 rounded-lg cursor-pointer mesa-status-livre';
                mesaEl.innerHTML = `
                    <span class="text-3xl font-bold">${i.toString().padStart(2, '0')}</span>
                    <span class="text-sm font-medium mt-2">Livre</span>
                `;
                mesaEl.addEventListener('click', () => handleMesaClick(i));
                mesasGrid.appendChild(mesaEl);
            }
        }

        function handleMesaClick(numeroMesa) {
            const mesaEl = document.getElementById(`mesa-${numeroMesa}`);
            const status = mesaEl.dataset.status;
            
            if (status === 'livre') {
                // Abre o atendente.html com o parâmetro da mesa para um novo pedido
                window.open(`atendente.html?mesa=${numeroMesa}`, '_blank');
            } else {
                // Se ocupada, abre o modal de edição com os detalhes do pedido da mesa
                const orderId = mesaEl.dataset.orderId;
                if (orderId) {
                    openEditModal(orderId);
                }
            }
        }
        
        function initializePDV() {
            // ... (código existente de loadDeliveryFees, audio, etc.)
            
            initializeMesas(); // Inicializa a grade de mesas

            const q = query(collection(db, "pedidos"), orderBy("criadoEm", "desc"));

            onSnapshot(q, (snapshot) => {
                connectionStatus.innerHTML = '<i class="fas fa-circle text-green-500 mr-2"></i>Conectado';
                
                // Limpa todas as colunas e reseta as mesas
                [colDeliveryNovo, colDeliveryPreparo, colDeliveryEntrega, colDeliveryFinalizado,
                 colRetiradaNovo, colRetiradaPreparo, colRetiradaPronto, colRetiradaFinalizado]
                 .forEach(col => col.innerHTML = '');
                initializeMesas();

                let totalOrdersToday = 0;
                let totalRevenueToday = 0;
                const today = new Date().setHours(0, 0, 0, 0);

                snapshot.docChanges().forEach((change) => {
                    const orderData = change.doc.data();
                    if (change.type === "added" && orderData.status === 'Novo') {
                        // Tocar som apenas para delivery/retirada
                        if (orderData.endereco.rua !== "Mesa") {
                            // playNotificationSound();
                        }
                    }
                });

                snapshot.docs.forEach(doc => {
                    const orderData = doc.data();
                    const orderId = doc.id;
                    const card = createOrderCard(orderData, orderId);

                    // Lógica de contagem de estatísticas (sem alteração)
                    // ...

                    // **LÓGICA DE DISTRIBUIÇÃO DOS PEDIDOS**
                    const tipoPedido = identifyOrderType(orderData);

                    if (tipoPedido === 'delivery') {
                        if (orderData.status === 'Novo') colDeliveryNovo.appendChild(card);
                        else if (orderData.status === 'Em Preparo') colDeliveryPreparo.appendChild(card);
                        else if (orderData.status === 'Pronto para Entrega') colDeliveryEntrega.appendChild(card);
                        else if (orderData.status === 'Finalizado') colDeliveryFinalizado.appendChild(card);
                    } else if (tipoPedido === 'retirada') {
                        if (orderData.status === 'Novo') colRetiradaNovo.appendChild(card);
                        else if (orderData.status === 'Em Preparo') colRetiradaPreparo.appendChild(card);
                        else if (orderData.status === 'Pronto para Entrega') colRetiradaPronto.appendChild(card); // 'Pronto para Entrega' é usado para 'Pronto para Retirada'
                        else if (orderData.status === 'Finalizado') colRetiradaFinalizado.appendChild(card);
                    } else if (tipoPedido === 'mesa') {
                        // Atualiza o status da mesa
                        const numeroMesa = parseInt(orderData.endereco.clientName.replace(/[^0-9]/g, ''));
                        if (numeroMesa && numeroMesa <= NUMERO_DE_MESAS && orderData.status !== 'Finalizado') {
                            const mesaEl = document.getElementById(`mesa-${numeroMesa}`);
                            mesaEl.classList.remove('mesa-status-livre');
                            mesaEl.classList.add('mesa-status-ocupada');
                            mesaEl.querySelector('span:last-child').textContent = 'Ocupada';
                            mesaEl.dataset.status = 'ocupada';
                            mesaEl.dataset.orderId = orderId;
                        }
                    }
                });
                // ... (código de atualização de estatísticas)
            });
        }

        function identifyOrderType(orderData) {
            if (orderData.endereco && orderData.endereco.rua === "Retirada no Balcão") {
                return 'retirada';
            }
            if (orderData.endereco && orderData.endereco.rua === "Mesa") {
                return 'mesa';
            }
            return 'delivery'; // Padrão é delivery
        }

        // A função createOrderCard permanece a mesma, pois o card é reutilizado
        // ... (código existente de createOrderCard, openEditModal, etc.)

        // --- FIM DA REESTRUTURAÇÃO ---

        // O restante do código (modais, logout, etc.) permanece praticamente o mesmo
        // ...
    </script>
</body>
</html>
