<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV - Sâmia Pizzaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/catalogo_pizzaria/refs/heads/main/logo.png" type="image/png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body {
            font-family: 'Roboto', sans-serif;
            visibility: hidden; /* Esconde o corpo da página até a verificação de login */
        }
        .full-height-container {
            height: calc(100vh - 10rem); 
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
        #pdv-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 999;
            display: none; /* Começa escondido */
        }
        /* Estilos para Impressão */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
        /* Estilos para CARD EXPANSÍVEL */
        .details-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .order-card.expanded .details-container {
            max-height: 1500px; /* Um valor alto para garantir que todo o conteúdo caiba */
        }
        /* Estilos para o Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4ade80; /* green-400 */
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4ade80; /* green-400 */
        }
        /* Estilo para botão de filtro ativo */
        .status-filter-btn.active {
            background-color: #2563eb; /* blue-600 */
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="pdv-overlay"></div>

    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Painel de Pedidos - Sâmia Pizzaria</h1>
            <div class="flex items-center space-x-2">
                <button id="add-manual-order-btn" class="px-3 py-2 bg-purple-600 text-white text-xs font-bold rounded-md hover:bg-purple-700">Novo Pedido Manual</button>
                <button id="close-cash-register-btn" class="px-3 py-2 bg-green-600 text-white text-xs font-bold rounded-md hover:bg-green-700">Fechar Caixa</button>
                <button id="manage-menu-btn" class="px-3 py-2 bg-blue-600 text-white text-xs font-bold rounded-md hover:bg-blue-700">Gerenciar Cardápio</button>
                <button id="clear-finished-btn" class="px-3 py-2 bg-gray-600 text-white text-xs font-bold rounded-md hover:bg-gray-700">Limpar Finalizados</button>
                <button id="logout-btn" class="px-3 py-2 bg-red-600 text-white text-xs font-bold rounded-md hover:bg-red-700">Sair</button>
                <div id="connection-status" class="text-sm font-medium text-gray-500">
                    <i class="fas fa-circle text-red-500 mr-2"></i>Conectando...
                </div>
            </div>
        </div>
    </header>

    <!-- Dashboard de Vendas -->
    <div class="bg-gray-800 text-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center py-4">
                <div>
                    <h3 class="text-sm font-medium text-gray-400">PEDIDOS HOJE</h3>
                    <p id="stats-total-orders" class="text-2xl font-bold">0</p>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-400">FATURAMENTO TOTAL</h3>
                    <p id="stats-total-revenue" class="text-2xl font-bold">R$ 0,00</p>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-400">TICKET MÉDIO</h3>
                    <p id="stats-avg-ticket" class="text-2xl font-bold">R$ 0,00</p>
                </div>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 full-height-container">
            
            <div class="bg-red-50 rounded-lg shadow">
                <div class="p-4 border-b border-red-200">
                    <h2 class="text-lg font-bold text-red-800">Novos Pedidos</h2>
                </div>
                <div id="col-novo" class="p-4 space-y-4 overflow-y-auto h-full"></div>
            </div>

            <div class="bg-yellow-50 rounded-lg shadow">
                <div class="p-4 border-b border-yellow-200">
                    <h2 class="text-lg font-bold text-yellow-800">Em Preparo</h2>
                </div>
                <div id="col-preparo" class="p-4 space-y-4 overflow-y-auto h-full"></div>
            </div>

            <div class="bg-green-50 rounded-lg shadow">
                <div class="p-4 border-b border-green-200">
                    <h2 class="text-lg font-bold text-green-800">Pronto para Entrega</h2>
                </div>
                <div id="col-entrega" class="p-4 space-y-4 overflow-y-auto h-full"></div>
            </div>
            
            <div class="bg-gray-200 rounded-lg shadow">
                <div class="p-4 border-b border-gray-300">
                    <h2 class="text-lg font-bold text-gray-800">Finalizados</h2>
                </div>
                <div id="col-finalizado" class="p-4 space-y-4 overflow-y-auto h-full"></div>
            </div>

        </div>
    </main>

    <!-- Modal Abrir Caixa -->
    <div id="open-cash-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Abrir Caixa</h3>
            <p class="text-sm text-gray-600 mb-4">Para iniciar as operações, por favor, informe o valor inicial do caixa (fundo de troco).</p>
            <form id="open-cash-form">
                <div class="mb-4">
                    <label for="initial-value" class="block text-sm font-medium text-gray-700 mb-1">Valor Inicial (R$)</label>
                    <input type="number" id="initial-value" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Ex: 50,00">
                </div>
                <button type="submit" id="open-cash-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">Abrir Caixa</button>
            </form>
        </div>
    </div>

    <!-- Modal Fechar Caixa -->
    <div id="close-cash-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Fechamento de Caixa</h3>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between"><span class="text-gray-600">Valor Inicial:</span> <span id="summary-initial" class="font-medium">R$ 0,00</span></div>
                <hr>
                <div class="flex justify-between"><span class="text-gray-600">Vendas em Dinheiro:</span> <span id="summary-cash" class="font-medium">R$ 0,00</span></div>
                <div class="flex justify-between"><span class="text-gray-600">Vendas em Cartão:</span> <span id="summary-card" class="font-medium">R$ 0,00</span></div>
                <div class="flex justify-between"><span class="text-gray-600">Vendas em Pix:</span> <span id="summary-pix" class="font-medium">R$ 0,00</span></div>
                <hr>
                <div class="flex justify-between font-bold"><span class="text-gray-800">Total de Vendas:</span> <span id="summary-total-sales" class="text-gray-800">R$ 0,00</span></div>
                <hr>
                <div class="flex justify-between font-bold"><span class="text-blue-700">Valor Esperado em Caixa:</span> <span id="summary-expected" class="text-blue-700">R$ 0,00</span></div>
            </div>
            <form id="close-cash-form" class="mt-6">
                <div class="mb-4">
                    <label for="final-value" class="block text-sm font-medium text-gray-700 mb-1">Valor Contado em Caixa (R$)</label>
                    <input type="number" id="final-value" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Digite o valor contado">
                </div>
                <div id="summary-difference-section" class="text-center p-2 rounded-md mb-4 hidden">
                    <span class="font-bold">Diferença:</span> <span id="summary-difference" class="font-bold">R$ 0,00</span>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-close-cash-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                    <button type="submit" id="confirm-close-cash-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Confirmar Fechamento</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Pedido Manual -->
    <div id="manual-order-modal" class="modal">
        <div class="modal-content !max-w-2xl">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Novo Pedido Manual</h2>
                <button id="close-manual-order-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <form id="manual-order-form">
                <!-- Dados do Cliente -->
                <div class="p-4 border border-gray-200 rounded-lg mb-4">
                    <h3 class="font-bold mb-2">Dados do Cliente</h3>
                     <div class="mb-2">
                        <label for="manual-clientName" class="block text-sm font-medium text-gray-700">Nome do Cliente</label>
                        <input type="text" id="manual-clientName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div class="flex items-center mb-2">
                        <input type="checkbox" id="pickup-checkbox" class="h-4 w-4 text-red-600 border-gray-300 rounded">
                        <label for="pickup-checkbox" class="ml-2 block text-sm text-gray-900">Retirada no Balcão</label>
                    </div>
                    <div id="delivery-fields">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="manual-street" class="block text-sm font-medium text-gray-700">Rua</label>
                                <input type="text" id="manual-street" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                             <div>
                                <label for="manual-number" class="block text-sm font-medium text-gray-700">Número</label>
                                <input type="text" id="manual-number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                        </div>
                        <div class="mt-2">
                            <label for="manual-neighborhood" class="block text-sm font-medium text-gray-700">Bairro</label>
                            <select id="manual-neighborhood" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                        </div>
                    </div>
                </div>

                <!-- Itens do Pedido -->
                <div class="p-4 border border-gray-200 rounded-lg mb-4">
                    <h3 class="font-bold mb-2">Itens do Pedido</h3>
                    <div id="manual-order-items" class="space-y-2 mb-2"></div>
                    <button type="button" id="add-item-btn" class="text-sm text-blue-600 hover:underline">+ Adicionar Item</button>
                </div>

                <!-- Totais e Pagamento -->
                <div class="p-4 border border-gray-200 rounded-lg">
                    <div class="flex justify-between text-sm"><span class="text-gray-600">Subtotal:</span> <span id="manual-subtotal" class="font-medium">R$ 0,00</span></div>
                    <div class="flex justify-between text-sm"><span class="text-gray-600">Taxa de Entrega:</span> <span id="manual-delivery-fee" class="font-medium">R$ 0,00</span></div>
                    <div class="flex justify-between font-bold mt-1"><span class="text-gray-800">Total:</span> <span id="manual-total" class="text-gray-800">R$ 0,00</span></div>
                    <div class="mt-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Forma de Pagamento</h4>
                        <div class="flex space-x-4">
                            <label class="flex items-center"><input type="radio" name="manual-payment" value="Dinheiro" checked class="form-radio"> <span class="ml-2">Dinheiro</span></label>
                            <label class="flex items-center"><input type="radio" name="manual-payment" value="Cartão de Crédito/Débito" class="form-radio"> <span class="ml-2">Cartão</span></label>
                            <label class="flex items-center"><input type="radio" name="manual-payment" value="Pix" class="form-radio"> <span class="ml-2">Pix</span></label>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end">
                    <button type="submit" class="w-full bg-purple-600 text-white font-bold py-2 px-4 rounded-md hover:bg-purple-700">Salvar Pedido</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Adicionar Item ao Pedido Manual -->
    <div id="add-item-modal" class="modal">
        <div class="modal-content">
            <h3 class="font-bold mb-2">Adicionar Item</h3>
            <input type="text" id="search-item-input" placeholder="Buscar item..." class="w-full p-2 border border-gray-300 rounded-md mb-2">
            <div id="item-list" class="max-h-60 overflow-y-auto"></div>
            <button id="cancel-add-item-btn" class="mt-4 w-full bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300">Cancelar</button>
        </div>
    </div>


    <!-- Modal Gerenciar Cardápio -->
    <div id="menu-management-modal" class="modal">
        <div class="modal-content !max-w-3xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Gerenciar Disponibilidade de Itens</h2>
                <button id="close-menu-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <!-- Filtros e Busca -->
            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="search-menu-input" placeholder="Buscar item pelo nome..." class="p-2 border border-gray-300 rounded-md w-full">
                    <select id="category-filter-select" class="p-2 border border-gray-300 rounded-md w-full">
                        <option value="all">Todas as Categorias</option>
                    </select>
                </div>
                <div id="status-filter-buttons" class="mt-2 flex space-x-2">
                    <button class="status-filter-btn active px-3 py-1 text-sm bg-gray-200 rounded-full" data-filter="all">Todos</button>
                    <button class="status-filter-btn px-3 py-1 text-sm bg-gray-200 rounded-full" data-filter="available">Disponíveis</button>
                    <button class="status-filter-btn px-3 py-1 text-sm bg-gray-200 rounded-full" data-filter="unavailable">Esgotados</button>
                </div>
            </div>
            <div id="menu-items-container" class="space-y-2 max-h-80 overflow-y-auto">
                <!-- Itens do cardápio serão inseridos aqui -->
            </div>
        </div>
    </div>

    <div id="edit-order-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Gerenciar Pedido</h2>
                <button id="close-edit-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="edit-modal-body" class="space-y-4"></div>
        </div>
    </div>

    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-lg max-w-sm mx-auto">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Confirmar Exclusão</h3>
            <p class="text-sm text-gray-600 mb-6">Tem certeza que deseja excluir este pedido? Esta ação não pode ser desfeita.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Sim, Excluir</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, getDoc, query, orderBy, where, writeBatch, setDoc, addDoc, serverTimestamp, getDocs, limit, Timestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBJ44RVDGhBIlQBTx-pyIUp47XDKzRXk84",
            authDomain: "pizzaria-pdv.firebaseapp.com",
            projectId: "pizzaria-pdv",
            storageBucket: "pizzaria-pdv.firebasestorage.app",
            messagingSenderId: "304171744691",
            appId: "1:304171744691:web:e54d7f9fe55c7a75485fc6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- LÓGICA DE AUTENTICAÇÃO E CAIXA ---
        let currentCashRegister = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.body.style.visibility = 'visible';
                checkCashRegisterStatus();
            } else {
                window.location.href = 'login.html';
            }
        });

        const logoutBtn = document.getElementById('logout-btn');
        logoutBtn.addEventListener('click', () => {
            signOut(auth).catch((error) => console.error("Erro ao fazer logout:", error));
        });
        
        const openCashModal = document.getElementById('open-cash-modal');
        const openCashForm = document.getElementById('open-cash-form');
        const pdvOverlay = document.getElementById('pdv-overlay');

        async function checkCashRegisterStatus() {
            const q = query(collection(db, "caixas"), where("status", "==", "aberto"), limit(1));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                pdvOverlay.style.display = 'block';
                openCashModal.style.display = 'flex';
            } else {
                currentCashRegister = { id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() };
                pdvOverlay.style.display = 'none';
                openCashModal.style.display = 'none';
                initializePDV();
            }
        }

        openCashForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const initialValue = parseFloat(document.getElementById('initial-value').value);
            if (isNaN(initialValue) || initialValue < 0) {
                alert("Por favor, insira um valor inicial válido.");
                return;
            }

            try {
                await addDoc(collection(db, "caixas"), {
                    dataAbertura: serverTimestamp(),
                    usuarioAbertura: auth.currentUser.email,
                    valorInicial: initialValue,
                    status: 'aberto'
                });
                checkCashRegisterStatus();
            } catch (error) {
                console.error("Erro ao abrir o caixa:", error);
                alert("Não foi possível abrir o caixa. Tente novamente.");
            }
        });
        // --- FIM DA LÓGICA DE CAIXA ---

        const colNovo = document.getElementById('col-novo');
        const colPreparo = document.getElementById('col-preparo');
        const colEntrega = document.getElementById('col-entrega');
        const colFinalizado = document.getElementById('col-finalizado');
        const connectionStatus = document.getElementById('connection-status');
        const editOrderModal = document.getElementById('edit-order-modal');
        const editModalBody = document.getElementById('edit-modal-body');
        const closeEditModalBtn = document.getElementById('close-edit-modal');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const clearFinishedBtn = document.getElementById('clear-finished-btn');
        const manageMenuBtn = document.getElementById('manage-menu-btn');
        const menuManagementModal = document.getElementById('menu-management-modal');
        const closeMenuModalBtn = document.getElementById('close-menu-modal');
        const menuItemsContainer = document.getElementById('menu-items-container');
        const searchMenuInput = document.getElementById('search-menu-input');
        const categoryFilterSelect = document.getElementById('category-filter-select');
        const statusFilterButtons = document.getElementById('status-filter-buttons');
        const closeCashRegisterBtn = document.getElementById('close-cash-register-btn');
        const closeCashModal = document.getElementById('close-cash-modal');
        const closeCashForm = document.getElementById('close-cash-form');
        const cancelCloseCashBtn = document.getElementById('cancel-close-cash-btn');
        const finalValueInput = document.getElementById('final-value');
        
        // --- Variáveis do Pedido Manual ---
        const addManualOrderBtn = document.getElementById('add-manual-order-btn');
        const manualOrderModal = document.getElementById('manual-order-modal');
        const closeManualOrderModalBtn = document.getElementById('close-manual-order-modal');
        const manualOrderForm = document.getElementById('manual-order-form');
        const pickupCheckbox = document.getElementById('pickup-checkbox');
        const deliveryFields = document.getElementById('delivery-fields');
        const manualNeighborhoodSelect = document.getElementById('manual-neighborhood');
        const addItemBtn = document.getElementById('add-item-btn');
        const addItemModal = document.getElementById('add-item-modal');
        const searchItemInput = document.getElementById('search-item-input');
        const itemListContainer = document.getElementById('item-list');
        const manualOrderItemsContainer = document.getElementById('manual-order-items');
        const cancelAddItemBtn = document.getElementById('cancel-add-item-btn');


        let fullMenuData = [];
        let deliveryFeesData = [];
        let manualOrderItems = [];


        let orderIdToDelete = null;

        function initializePDV() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            function playNotificationSound() {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 1);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 1);
            }

            const q = query(collection(db, "pedidos"), orderBy("criadoEm", "desc"));

            const unsubscribe = onSnapshot(q, (snapshot) => {
                connectionStatus.innerHTML = '<i class="fas fa-circle text-green-500 mr-2"></i>Conectado';
                
                colNovo.innerHTML = '';
                colPreparo.innerHTML = '';
                colEntrega.innerHTML = '';
                colFinalizado.innerHTML = '';

                let totalOrdersToday = 0;
                let totalRevenueToday = 0;
                const today = new Date().setHours(0, 0, 0, 0);

                snapshot.docChanges().forEach((change) => {
                    const orderData = change.doc.data();
                    if (change.type === "added" && orderData.status === 'Novo') {
                        playNotificationSound();
                    }
                });

                snapshot.docs.forEach(doc => {
                    const orderData = doc.data();
                    const orderId = doc.id;
                    const card = createOrderCard(orderData, orderId);

                    const orderDate = orderData.criadoEm ? new Date(orderData.criadoEm.seconds * 1000).setHours(0, 0, 0, 0) : today;
                    if(orderDate === today) {
                        totalOrdersToday++;
                        totalRevenueToday += orderData.total.finalTotal;
                    }

                    if (orderData.status === 'Novo') colNovo.appendChild(card);
                    else if (orderData.status === 'Em Preparo') colPreparo.appendChild(card);
                    else if (orderData.status === 'Pronto para Entrega') colEntrega.appendChild(card);
                    else if (orderData.status === 'Finalizado') colFinalizado.appendChild(card);
                });

                document.getElementById('stats-total-orders').textContent = totalOrdersToday;
                document.getElementById('stats-total-revenue').textContent = `R$ ${totalRevenueToday.toFixed(2).replace('.', ',')}`;
                document.getElementById('stats-avg-ticket').textContent = totalOrdersToday > 0 ? `R$ ${(totalRevenueToday / totalOrdersToday).toFixed(2).replace('.', ',')}` : 'R$ 0,00';

            }, (error) => {
                console.error("Erro ao ouvir pedidos: ", error);
                connectionStatus.innerHTML = '<i class="fas fa-circle text-red-500 mr-2"></i>Erro de conexão';
            });
        }

        function createOrderCard(order, id) {
            const card = document.createElement('div');
            card.className = 'order-card bg-white rounded-lg shadow-md border-l-4';
            
            let itemsHtml = order.itens.map(item => {
                let itemContent = `<li class="flex justify-between text-sm"><span>${item.name}</span><span class="font-medium">R$ ${item.price.toFixed(2).replace('.', ',')}</span></li>`;

                if (item.type === 'custom_burger' && item.ingredients && item.ingredients.length > 0) {
                    const ingredientsList = item.ingredients.map(ingredient => `
                        <li class="text-xs text-gray-500 ml-4 list-disc">${ingredient.name}</li>
                    `).join('');
                    itemContent += `<ul class="mt-1 space-y-1">${ingredientsList}</ul>`;
                }

                return itemContent;
            }).join('');

            const timestamp = order.criadoEm ? new Date(order.criadoEm.seconds * 1000).toLocaleTimeString('pt-BR') : 'agora';

            let buttonHtml = '';
            if (order.status === 'Novo') {
                card.classList.add('border-red-500');
                buttonHtml = `<button data-id="${id}" data-status="Em Preparo" class="move-btn w-full mt-4 bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 transition-colors">Iniciar Preparo</button>`;
            } else if (order.status === 'Em Preparo') {
                card.classList.add('border-yellow-500');
                buttonHtml = `<button data-id="${id}" data-status="Pronto para Entrega" class="move-btn w-full mt-4 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">Pronto para Entrega</button>`;
            } else if (order.status === 'Pronto para Entrega') {
                card.classList.add('border-green-500');
                buttonHtml = `<button data-id="${id}" data-status="Finalizado" class="move-btn w-full mt-4 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">Finalizar Pedido</button>`;
            }

            let paymentHtml = '';
            if (order.pagamento) {
                let paymentText = '';
                if (typeof order.pagamento === 'object' && order.pagamento.method === 'Dinheiro') {
                    paymentText = `Dinheiro (Troco p/ R$ ${order.pagamento.trocoPara.toFixed(2).replace('.', ',')})`;
                } else {
                    paymentText = order.pagamento;
                }
                paymentHtml = `<div class="text-sm mt-2 pt-2 border-t border-gray-200"><strong>Pagamento:</strong> ${paymentText}</div>`;
            }

            let totalDetailsHtml = `
                <div class="text-right text-sm space-y-1 mt-2 pt-2 border-t border-gray-200">
                    <div class="flex justify-between">
                        <span>Subtotal:</span>
                        <span>R$ ${order.total.subtotal.toFixed(2).replace('.', ',')}</span>
                    </div>
            `;
            if (order.total.discount > 0) {
                totalDetailsHtml += `
                    <div class="flex justify-between text-red-600">
                        <span>Desconto:</span>
                        <span>- R$ ${order.total.discount.toFixed(2).replace('.', ',')}</span>
                    </div>
                `;
            }
            totalDetailsHtml += `
                    <div class="flex justify-between">
                        <span>Taxa de Entrega:</span>
                        <span>R$ ${order.total.deliveryFee.toFixed(2).replace('.', ',')}</span>
                    </div>
                    <div class="flex justify-between font-bold text-lg text-gray-800">
                        <span>Total:</span>
                        <span>R$ ${order.total.finalTotal.toFixed(2).replace('.', ',')}</span>
                    </div>
                </div>
            `;

            card.innerHTML = `
                <div class="card-header flex justify-between items-start cursor-pointer p-4">
                    <div>
                        <h3 class="font-bold text-gray-800">Pedido #${id.substring(0, 5)}</h3>
                        <p class="text-sm font-medium text-gray-700">${order.endereco.clientName}</p>
                    </div>
                    <div class="text-right flex-shrink-0 ml-4">
                        <span class="font-bold text-lg text-gray-800 block">R$ ${order.total.finalTotal.toFixed(2).replace('.', ',')}</span>
                        <span class="text-xs text-gray-500">Clique para ver mais</span>
                    </div>
                </div>
                <div class="details-container">
                    <div class="px-4 pb-4">
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-medium text-gray-500">${timestamp}</span>
                                <div class="flex items-center space-x-2">
                                    <button data-id="${id}" data-type="kitchen" class="print-btn text-gray-500 hover:text-gray-700" title="Imprimir Comanda da Cozinha"><i class="fas fa-utensils"></i></button>
                                    <button data-id="${id}" data-type="client" class="print-btn text-gray-500 hover:text-gray-700" title="Imprimir Recibo do Cliente"><i class="fas fa-receipt"></i></button>
                                    <button data-id="${id}" class="manage-btn text-blue-500 hover:text-blue-700" title="Editar Pedido"><i class="fas fa-edit"></i></button>
                                </div>
                            </div>
                            <div class="mb-2">
                                <p class="text-xs text-gray-500">${order.endereco.rua}, ${order.endereco.numero} - ${order.endereco.bairro}</p>
                            </div>
                            <ul class="border-t border-b border-gray-200 py-2 my-2 space-y-1">${itemsHtml}</ul>
                            ${totalDetailsHtml}
                            ${paymentHtml}
                            ${buttonHtml}
                        </div>
                    </div>
                </div>
            `;
            return card;
        }

        async function openEditModal(id) {
            const orderRef = doc(db, "pedidos", id);
            const docSnap = await getDoc(orderRef);

            if (docSnap.exists()) {
                const order = docSnap.data();
                editModalBody.innerHTML = `
                    <input type="hidden" id="edit-order-id" value="${id}">
                    <div>
                        <label for="edit-clientName" class="block text-sm font-medium text-gray-700">Nome do Cliente</label>
                        <input type="text" id="edit-clientName" value="${order.endereco.clientName}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="edit-rua" class="block text-sm font-medium text-gray-700">Rua</label>
                        <input type="text" id="edit-rua" value="${order.endereco.rua}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                     <div>
                        <label for="edit-numero" class="block text-sm font-medium text-gray-700">Número</label>
                        <input type="text" id="edit-numero" value="${order.endereco.numero}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="edit-bairro" class="block text-sm font-medium text-gray-700">Bairro</label>
                        <input type="text" id="edit-bairro" value="${order.endereco.bairro}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div class="mt-4 flex justify-between">
                        <button id="save-changes-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">Salvar Alterações</button>
                        <button id="delete-order-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Excluir Pedido</button>
                    </div>
                `;
                editOrderModal.style.display = 'flex';
            } else {
                console.log("Nenhum pedido encontrado!");
            }
        }

        async function updateOrderStatus(id, newStatus) {
            const orderRef = doc(db, "pedidos", id);
            try {
                await updateDoc(orderRef, { status: newStatus });
            } catch (error) {
                console.error("Erro ao atualizar status: ", error);
            }
        }
        
        async function saveOrderChanges() {
            const id = document.getElementById('edit-order-id').value;
            const orderRef = doc(db, "pedidos", id);
            const updatedData = {
                "endereco.clientName": document.getElementById('edit-clientName').value,
                "endereco.rua": document.getElementById('edit-rua').value,
                "endereco.numero": document.getElementById('edit-numero').value,
                "endereco.bairro": document.getElementById('edit-bairro').value,
            };
            try {
                await updateDoc(orderRef, updatedData);
                editOrderModal.style.display = 'none';
            } catch (error) {
                console.error("Erro ao salvar alterações: ", error);
            }
        }

        function showDeleteConfirmation() {
            orderIdToDelete = document.getElementById('edit-order-id').value;
            deleteConfirmModal.style.display = 'flex';
        }

        async function executeDelete() {
            if (orderIdToDelete) {
                try {
                    await deleteDoc(doc(db, "pedidos", orderIdToDelete));
                    editOrderModal.style.display = 'none';
                    deleteConfirmModal.style.display = 'none';
                    orderIdToDelete = null;
                } catch (error) {
                    console.error("Erro ao excluir pedido: ", error);
                }
            }
        }

        function printOrder(id, type) {
            const orderRef = doc(db, "pedidos", id);
            getDoc(orderRef).then(docSnap => {
                if (docSnap.exists()) {
                    const order = docSnap.data();
                    let printContent = '';

                    if (type === 'kitchen') {
                        // Lógica para a comanda da cozinha - incluindo os ingredientes do hambúrguer
                        let itemsKitchenHtml = order.itens.map(item => {
                            let itemString = `<li style="padding: 8px 0; border-bottom: 1px dashed #ccc;"><strong>1x</strong> ${item.name}</li>`;
                            if (item.type === 'custom_burger' && item.ingredients && item.ingredients.length > 0) {
                                itemString += `<ul style="list-style: none; padding-left: 20px;">${item.ingredients.map(ing => `<li style="font-size: 16px;">- ${ing.name}</li>`).join('')}</ul>`;
                            }
                            return itemString;
                        }).join('');

                        printContent = `
                            <div style="font-family: monospace; padding: 20px; font-size: 16px;">
                                <h2 style="text-align: center; font-size: 28px; margin-bottom: 20px;">COMANDA COZINHA</h2>
                                <p style="font-size: 18px;"><strong>Pedido:</strong> #${id.substring(0, 5)}</p>
                                <p style="font-size: 18px;"><strong>Cliente:</strong> ${order.endereco.clientName}</p>
                                <hr style="border-top: 2px dashed black; margin: 15px 0;">
                                <ul style="font-size: 20px; list-style: none; padding: 0;">
                                    ${itemsKitchenHtml}
                                </ul>
                            </div>
                        `;
                    } else { // client receipt
                        let paymentDetailsHtml = '';
                        if (order.pagamento) {
                            let paymentText = '';
                            let changeText = '';
                            if (typeof order.pagamento === 'object' && order.pagamento.method === 'Dinheiro') {
                                paymentText = 'Dinheiro';
                                changeText = `
                                    <p>Troco para: R$ ${order.pagamento.trocoPara.toFixed(2).replace('.', ',')}</p>
                                    <p>Troco: R$ ${(order.pagamento.trocoPara - order.total.finalTotal).toFixed(2).replace('.', ',')}</p>
                                `;
                            } else {
                                paymentText = order.pagamento;
                            }
                            paymentDetailsHtml = `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed black;">
                                    <p style="font-weight: bold;">Forma de Pagamento: ${paymentText}</p>
                                    ${changeText}
                                </div>
                            `;
                        }

                        printContent = `
                            <div style="font-family: monospace; padding: 20px;">
                                <h2 style="text-align: center; font-size: 24px; margin-bottom: 20px;">Sâmia Pizzaria</h2>
                                <p><strong>Pedido:</strong> #${id.substring(0, 5)}</p>
                                <p><strong>Cliente:</strong> ${order.endereco.clientName}</p>
                                <p><strong>Endereço:</strong> ${order.endereco.rua}, ${order.endereco.numero} - ${order.endereco.bairro}</p>
                                <hr style="border-top: 1px dashed black; margin: 15px 0;">
                                <ul>
                                    ${order.itens.map((item, index) => `<li style="display: flex; justify-content: space-between; padding: 5px 0; ${index === order.itens.length - 1 ? '' : 'border-bottom: 1px dashed #ccc;'}"><span>${item.name}</span><span>R$${item.price.toFixed(2).replace('.', ',')}</span></li>`).join('')}
                                </ul>
                                <hr style="border-top: 1px dashed black; margin: 15px 0;">
                                <div style="text-align: right;">
                                    <p>Subtotal: R$ ${order.total.subtotal.toFixed(2).replace('.', ',')}</p>
                                    ${order.total.discount > 0 ? `<p>Desconto: -R$ ${order.total.discount.toFixed(2).replace('.', ',')}</p>` : ''}
                                    <p>Taxa de Entrega: R$ ${order.total.deliveryFee.toFixed(2).replace('.', ',')}</p>
                                    <p style="font-weight: bold; font-size: 18px;">Total: R$ ${order.total.finalTotal.toFixed(2).replace('.', ',')}</p>
                                </div>
                                ${paymentDetailsHtml}
                            </div>
                        `;
                    }

                    const printWindow = window.open('', '', 'height=600,width=800');
                    printWindow.document.write('<html><head><title>Imprimir Pedido</title></head><body><div id="print-area">');
                    printWindow.document.write(printContent);
                    printWindow.document.write('</div></body></html>');
                    printWindow.document.close();
                    printWindow.print();
                }
            });
        }
        
        async function clearFinishedOrders() {
            if (!confirm("Tem certeza que deseja limpar todos os pedidos finalizados da tela? Eles serão arquivados.")) {
                return;
            }
            const q = query(collection(db, "pedidos"), where("status", "==", "Finalizado"));
            const snapshot = await getDoc(q);
            const batch = writeBatch(db);
            snapshot.docs.forEach(doc => {
                batch.update(doc.ref, { status: "Arquivado" });
            });
            await batch.commit();
        }

        // --- LÓGICA ATUALIZADA PARA GERENCIAR O CARDÁPIO ---
        function filterMenuItems() {
            const searchText = searchMenuInput.value.toLowerCase();
            const selectedCategory = categoryFilterSelect.value;
            const activeStatusFilter = statusFilterButtons.querySelector('.active').dataset.filter;

            const items = menuItemsContainer.querySelectorAll('.menu-item-row');
            items.forEach(item => {
                const itemName = item.dataset.name.toLowerCase();
                const itemCategory = item.dataset.category;
                const itemStatus = item.querySelector('.toggle-checkbox').checked ? 'available' : 'unavailable';

                const nameMatch = itemName.includes(searchText);
                const categoryMatch = selectedCategory === 'all' || itemCategory === selectedCategory;
                const statusMatch = activeStatusFilter === 'all' || itemStatus === activeStatusFilter;

                if (nameMatch && categoryMatch && statusMatch) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        async function openMenuManagementModal() {
            menuItemsContainer.innerHTML = '<p>Carregando cardápio...</p>';
            menuManagementModal.style.display = 'flex';

            try {
                const response = await fetch('/api/menu');
                if (!response.ok) throw new Error('Falha ao carregar o cardápio');
                
                const data = await response.json();
                
                const allItems = data.cardapio.filter(item => item.id && item.name);
                const categories = [...new Set(allItems.map(item => item.category))];

                categoryFilterSelect.innerHTML = '<option value="all">Todas as Categorias</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilterSelect.appendChild(option);
                });
                
                const itemStatusRef = doc(db, "config", "item_status");
                const itemStatusSnap = await getDoc(itemStatusRef);
                const unavailableItems = itemStatusSnap.exists() ? itemStatusSnap.data() : {};

                menuItemsContainer.innerHTML = '';
                allItems.forEach(item => {
                    const isChecked = !unavailableItems.hasOwnProperty(item.id);
                    const itemElement = document.createElement('div');
                    itemElement.className = 'menu-item-row flex items-center justify-between p-2 bg-gray-50 rounded';
                    itemElement.dataset.name = item.name;
                    itemElement.dataset.category = item.category;

                    itemElement.innerHTML = `
                        <div>
                            <span class="font-medium">${item.name}</span>
                            <span class="text-xs text-gray-500 ml-2">${item.category}</span>
                        </div>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="toggle-${item.id}" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" 
                                   data-item-id="${item.id}" ${isChecked ? 'checked' : ''}/>
                            <label for="toggle-${item.id}" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    `;
                    menuItemsContainer.appendChild(itemElement);

                    itemElement.querySelector('.toggle-checkbox').addEventListener('change', async (e) => {
                        const itemId = e.target.dataset.itemId;
                        const available = e.target.checked;
                        
                        const currentStatusSnap = await getDoc(itemStatusRef);
                        const currentStatus = currentStatusSnap.exists() ? currentStatusSnap.data() : {};

                        if (available) {
                            delete currentStatus[itemId];
                        } else {
                            currentStatus[itemId] = false;
                        }

                        await setDoc(itemStatusRef, currentStatus);
                    });
                });
                filterMenuItems(); // Aplica o filtro inicial

            } catch (error) {
                menuItemsContainer.innerHTML = `<p class="text-red-500">Erro ao carregar cardápio: ${error.message}</p>`;
            }
        }

        manageMenuBtn.addEventListener('click', openMenuManagementModal);
        closeMenuModalBtn.addEventListener('click', () => {
            menuManagementModal.style.display = 'none';
        });

        searchMenuInput.addEventListener('input', filterMenuItems);
        categoryFilterSelect.addEventListener('change', filterMenuItems);
        statusFilterButtons.addEventListener('click', (e) => {
            if (e.target.classList.contains('status-filter-btn')) {
                statusFilterButtons.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                filterMenuItems();
            }
        });
        // --- FIM DA LÓGICA ATUALIZADA ---

        closeCashRegisterBtn.addEventListener('click', async () => {
            if (!currentCashRegister) {
                alert("Nenhum caixa aberto para fechar.");
                return;
            }

            const ordersQuery = query(
                collection(db, "pedidos"),
                where("status", "==", "Finalizado")
            );
            const ordersSnapshot = await getDocs(ordersQuery);

            let totalCash = 0;
            let totalCard = 0;
            let totalPix = 0;

            ordersSnapshot.forEach(doc => {
                const order = doc.data();
                if (order.criadoEm && order.criadoEm.seconds >= currentCashRegister.dataAbertura.seconds) {
                    const payment = order.pagamento;
                    const total = order.total.finalTotal;

                    if (typeof payment === 'object' && payment.method === 'Dinheiro') {
                        totalCash += total;
                    } else if (payment === 'Cartão de Crédito/Débito') {
                        totalCard += total;
                    } else if (payment === 'Pix') {
                        totalPix += total;
                    }
                }
            });

            const totalSales = totalCash + totalCard + totalPix;
            const expectedInCash = currentCashRegister.valorInicial + totalCash;

            document.getElementById('summary-initial').textContent = `R$ ${currentCashRegister.valorInicial.toFixed(2).replace('.', ',')}`;
            document.getElementById('summary-cash').textContent = `R$ ${totalCash.toFixed(2).replace('.', ',')}`;
            document.getElementById('summary-card').textContent = `R$ ${totalCard.toFixed(2).replace('.', ',')}`;
            document.getElementById('summary-pix').textContent = `R$ ${totalPix.toFixed(2).replace('.', ',')}`;
            document.getElementById('summary-total-sales').textContent = `R$ ${totalSales.toFixed(2).replace('.', ',')}`;
            document.getElementById('summary-expected').textContent = `R$ ${expectedInCash.toFixed(2).replace('.', ',')}`;

            closeCashModal.style.display = 'flex';
        });

        cancelCloseCashBtn.addEventListener('click', () => {
            closeCashModal.style.display = 'none';
        });

        finalValueInput.addEventListener('input', () => {
            const expectedText = document.getElementById('summary-expected').textContent;
            const expectedValue = parseFloat(expectedText.replace('R$ ', '').replace(',', '.'));
            const finalValue = parseFloat(finalValueInput.value);
            const differenceSection = document.getElementById('summary-difference-section');
            const differenceEl = document.getElementById('summary-difference');

            if (!isNaN(finalValue)) {
                const difference = finalValue - expectedValue;
                differenceEl.textContent = `R$ ${difference.toFixed(2).replace('.', ',')}`;
                if (difference < 0) {
                    differenceSection.className = 'text-center p-2 rounded-md mb-4 bg-red-100 text-red-700';
                } else if (difference > 0) {
                    differenceSection.className = 'text-center p-2 rounded-md mb-4 bg-yellow-100 text-yellow-700';
                } else {
                    differenceSection.className = 'text-center p-2 rounded-md mb-4 bg-green-100 text-green-700';
                }
                differenceSection.classList.remove('hidden');
            } else {
                differenceSection.classList.add('hidden');
            }
        });

        closeCashForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const finalValue = parseFloat(finalValueInput.value);
            if (isNaN(finalValue) || finalValue < 0) {
                alert("Por favor, insira um valor válido.");
                return;
            }
            
            const cashRegisterRef = doc(db, "caixas", currentCashRegister.id);
            const expectedValue = parseFloat(document.getElementById('summary-expected').textContent.replace('R$ ', '').replace(',', '.'));
            const totalSales = parseFloat(document.getElementById('summary-total-sales').textContent.replace('R$ ', '').replace(',', '.'));
            const totalCash = parseFloat(document.getElementById('summary-cash').textContent.replace('R$ ', '').replace(',', '.'));
            const totalCard = parseFloat(document.getElementById('summary-card').textContent.replace('R$ ', '').replace(',', '.'));
            const totalPix = parseFloat(document.getElementById('summary-pix').textContent.replace('R$ ', '').replace(',', '.'));

            try {
                await updateDoc(cashRegisterRef, {
                    status: 'fechado',
                    dataFechamento: serverTimestamp(),
                    usuarioFechamento: auth.currentUser.email,
                    valorFinalContado: finalValue,
                    diferenca: finalValue - expectedValue,
                    totalVendas: totalSales,
                    totalDinheiro: totalCash,
                    totalCartao: totalCard,
                    totalPix: totalPix
                });
                alert("Caixa fechado com sucesso!");
                closeCashModal.style.display = 'none';
                checkCashRegisterStatus(); // Bloqueia a tela
            } catch (error) {
                console.error("Erro ao fechar o caixa:", error);
                alert("Não foi possível fechar o caixa. Tente novamente.");
            }
        });
        
        // =================================================================
        // == INÍCIO DA LÓGICA CORRIGIDA PARA O PEDIDO MANUAL ==
        // =================================================================
        
        async function openManualOrderModal() {
            // Reseta o formulário e a lista de itens
            manualOrderForm.reset();
            manualOrderItems = [];
            updateManualOrderDisplay();

            // Carrega os dados do cardápio e taxas de entrega se ainda não foram carregados
            if (deliveryFeesData.length === 0 || fullMenuData.length === 0) {
                try {
                    const response = await fetch('/api/menu');
                    const data = await response.json();
                    deliveryFeesData = data.deliveryFees;
                    fullMenuData = data.cardapio.filter(item => item.available); // Pega apenas itens disponíveis
                } catch (error) {
                    console.error("Erro ao carregar dados para o pedido manual:", error);
                    alert("Não foi possível carregar os dados do cardápio. Tente novamente.");
                    return;
                }
            }

            // Preenche o seletor de bairros
            manualNeighborhoodSelect.innerHTML = '<option value="">Selecione o Bairro</option>';
            deliveryFeesData.forEach(fee => {
                const option = document.createElement('option');
                option.value = fee.neighborhood;
                option.dataset.fee = fee.deliveryFee;
                option.textContent = `${fee.neighborhood} - R$ ${fee.deliveryFee.toFixed(2).replace('.', ',')}`;
                manualNeighborhoodSelect.appendChild(option);
            });

            // Mostra o modal
            manualOrderModal.style.display = 'flex';
        }
        
        function updateManualOrderDisplay() {
            manualOrderItemsContainer.innerHTML = '';
            let subtotal = 0;

            manualOrderItems.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex justify-between items-center text-sm';
                itemEl.innerHTML = `
                    <span>${item.name}</span>
                    <div class="flex items-center">
                        <span class="font-medium mr-4">R$ ${item.price.toFixed(2).replace('.', ',')}</span>
                        <button type="button" data-index="${index}" class="remove-manual-item-btn text-red-500 hover:text-red-700">&times;</button>
                    </div>
                `;
                manualOrderItemsContainer.appendChild(itemEl);
                subtotal += item.price;
            });
            
            const isPickup = pickupCheckbox.checked;
            const selectedNeighborhood = manualNeighborhoodSelect.options[manualNeighborhoodSelect.selectedIndex];
            
            // CORREÇÃO: Adiciona uma verificação para garantir que selectedNeighborhood não é undefined
            let deliveryFee = 0;
            if (!isPickup && selectedNeighborhood && selectedNeighborhood.value !== '') {
                deliveryFee = parseFloat(selectedNeighborhood.dataset.fee || 0);
            }
            
            const total = subtotal + deliveryFee;

            document.getElementById('manual-subtotal').textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
            document.getElementById('manual-delivery-fee').textContent = `R$ ${deliveryFee.toFixed(2).replace('.', ',')}`;
            document.getElementById('manual-total').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }

        function openAddItemModal() {
            searchItemInput.value = '';
            renderItemList('');
            addItemModal.style.display = 'flex';
        }
        
        function renderItemList(filterText) {
            itemListContainer.innerHTML = '';
            const filteredMenu = fullMenuData.filter(item => item.name.toLowerCase().includes(filterText.toLowerCase()));

            filteredMenu.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'p-2 hover:bg-gray-100 cursor-pointer flex justify-between items-center';
                itemEl.textContent = item.name;
                
                const priceSpan = document.createElement('span');
                priceSpan.className = 'font-bold text-sm text-gray-700';
                // Lida com diferentes estruturas de preço (pizza vs. outros)
                const price = item.basePrice || item.price4Slices || item.price6Slices || 0;
                priceSpan.textContent = `R$ ${price.toFixed(2).replace('.', ',')}`;
                itemEl.appendChild(priceSpan);

                itemEl.addEventListener('click', () => {
                    manualOrderItems.push({
                        name: item.name,
                        price: price,
                        // Adicione mais detalhes do item se necessário
                    });
                    updateManualOrderDisplay();
                    addItemModal.style.display = 'none';
                });
                itemListContainer.appendChild(itemEl);
            });
        }

        async function handleManualOrderSubmit(e) {
            e.preventDefault();
            
            const clientName = document.getElementById('manual-clientName').value;
            const isPickup = pickupCheckbox.checked;
            const street = document.getElementById('manual-street').value;
            const number = document.getElementById('manual-number').value;
            const neighborhood = manualNeighborhoodSelect.value;
            const paymentMethod = document.querySelector('input[name="manual-payment"]:checked').value;

            if (!clientName || manualOrderItems.length === 0) {
                alert("Por favor, preencha o nome do cliente e adicione pelo menos um item.");
                return;
            }
            if (!isPickup && !neighborhood) {
                alert("Por favor, selecione um bairro para entrega.");
                return;
            }

            const subtotal = manualOrderItems.reduce((sum, item) => sum + item.price, 0);
            const selectedNeighborhoodOption = manualNeighborhoodSelect.options[manualNeighborhoodSelect.selectedIndex];
            const deliveryFee = isPickup || !selectedNeighborhoodOption || selectedNeighborhoodOption.value === '' ? 0 : parseFloat(selectedNeighborhoodOption.dataset.fee || 0);
            const finalTotal = subtotal + deliveryFee;

            const newOrder = {
                itens: manualOrderItems,
                endereco: {
                    clientName: clientName,
                    rua: isPickup ? "Retirada no Balcão" : street,
                    numero: isPickup ? "" : number,
                    bairro: isPickup ? "" : neighborhood,
                },
                total: {
                    subtotal: subtotal,
                    deliveryFee: deliveryFee,
                    finalTotal: finalTotal,
                    discount: 0
                },
                pagamento: paymentMethod,
                status: 'Novo',
                criadoEm: serverTimestamp()
            };

            try {
                await addDoc(collection(db, "pedidos"), newOrder);
                alert("Pedido manual salvo com sucesso!");
                manualOrderModal.style.display = 'none';
            } catch (error) {
                console.error("Erro ao salvar pedido manual: ", error);
                alert("Ocorreu um erro ao salvar o pedido. Tente novamente.");
            }
        }

        // Adiciona os event listeners para a funcionalidade de pedido manual
        addManualOrderBtn.addEventListener('click', openManualOrderModal);
        closeManualOrderModalBtn.addEventListener('click', () => manualOrderModal.style.display = 'none');
        addItemBtn.addEventListener('click', openAddItemModal);
        cancelAddItemBtn.addEventListener('click', () => addItemModal.style.display = 'none');
        searchItemInput.addEventListener('input', (e) => renderItemList(e.target.value));
        manualOrderForm.addEventListener('submit', handleManualOrderSubmit);
        pickupCheckbox.addEventListener('change', () => {
            deliveryFields.style.display = pickupCheckbox.checked ? 'none' : 'block';
            updateManualOrderDisplay();
        });
        manualNeighborhoodSelect.addEventListener('change', updateManualOrderDisplay);
        manualOrderItemsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-manual-item-btn') || e.target.parentElement.classList.contains('remove-manual-item-btn')) {
                const button = e.target.closest('.remove-manual-item-btn');
                const index = parseInt(button.dataset.index);
                manualOrderItems.splice(index, 1);
                updateManualOrderDisplay();
            }
        });

        // =================================================================
        // == FIM DA LÓGICA CORRIGIDA PARA O PEDIDO MANUAL ==
        // =================================================================


        document.querySelector('main').addEventListener('click', function(e) {
            const moveBtn = e.target.closest('.move-btn');
            const manageBtn = e.target.closest('.manage-btn');
            const printBtn = e.target.closest('.print-btn');

            if (moveBtn) {
                const orderId = moveBtn.dataset.id;
                const newStatus = moveBtn.dataset.status;
                updateOrderStatus(orderId, newStatus);
            }
            if (manageBtn) {
                const orderId = manageBtn.dataset.id;
                openEditModal(orderId);
            }
            if (printBtn) {
                const orderId = printBtn.dataset.id;
                const printType = printBtn.dataset.type;
                printOrder(orderId, printType);
            }

            const cardHeader = e.target.closest('.card-header');
            if (cardHeader) {
                const card = cardHeader.closest('.order-card');
                if (card) {
                    if (!e.target.closest('button, a')) {
                        card.classList.toggle('expanded');
                    }
                }
            }
        });

        closeEditModalBtn.addEventListener('click', () => {
            editOrderModal.style.display = 'none';
        });

        editModalBody.addEventListener('click', function(e) {
            if (e.target.id === 'save-changes-btn') {
                saveOrderChanges();
            }
            if (e.target.id === 'delete-order-btn') {
                showDeleteConfirmation();
            }
        });

        cancelDeleteBtn.addEventListener('click', () => {
            deleteConfirmModal.style.display = 'none';
            orderIdToDelete = null;
        });

        confirmDeleteBtn.addEventListener('click', executeDelete);
        clearFinishedBtn.addEventListener('click', clearFinishedOrders);

    </script>
</body>
</html>
