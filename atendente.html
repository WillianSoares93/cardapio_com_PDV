<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sâmia - Lançamento de Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/cardapio_samia/refs/heads/main/logo.png" type="image/png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f4e9;
            visibility: hidden;
        }
        .category-bar-mobile-sticky {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f8f4e9;
            padding-top: 1rem;
            padding-bottom: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .pizza-category-section {
            scroll-margin-top: 6rem;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
    </style>
</head>
<body>
    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Lançamento de Pedidos</h1>
            <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white text-sm font-bold rounded-md hover:bg-red-700">Sair</button>
        </div>
    </header>

    <div class="flex flex-col lg:flex-row max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 gap-8">
        <!-- Coluna do Cardápio -->
        <div class="lg:w-2/3 px-4 lg:px-0">
            <div class="category-bar-mobile-sticky">
                <div id="category-buttons-container" class="flex space-x-2 mb-6 overflow-x-auto pb-2"></div>
            </div>
            <div id="pizza-list">
                <div id="dynamic-pizza-sections"></div>
            </div>
            <div id="loading-state" class="text-center py-10">Carregando cardápio...</div>
        </div>

        <!-- Coluna do Pedido -->
        <div class="lg:w-1/3 px-4 lg:px-0">
            <div class="bg-white p-6 rounded-lg shadow-lg sticky top-6">
                <h2 class="text-xl font-bold mb-4">Pedido Atual</h2>
                <div id="orderItems" class="mb-4 max-h-64 overflow-y-auto">
                    <p id="emptyOrderMessage" class="text-gray-500">Nenhum item no pedido.</p>
                </div>
                <div class="border-t pt-4">
                    <div class="flex justify-between font-bold text-lg">
                        <span>Total:</span>
                        <span id="total">R$ 0,00</span>
                    </div>
                </div>
                <button id="finalize-order-btn" class="w-full mt-4 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors">
                    Finalizar Pedido
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Finalização -->
    <div id="finalize-order-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Finalizar Pedido</h3>
            <div class="mb-4">
                <label for="clientNameInput" class="block text-sm font-medium text-gray-700">Nome do Cliente / Mesa</label>
                <input type="text" id="clientNameInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Ex: Mesa 05 ou João (Retirada)">
            </div>
             <div class="mb-4">
                <label for="contactInput" class="block text-sm font-medium text-gray-700">Contato (Opcional)</label>
                <input type="tel" id="contactInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="(99) 99999-9999">
            </div>
            <div class="mb-4">
                <label for="paymentMethodSelect" class="block text-sm font-medium text-gray-700">Forma de Pagamento</label>
                <select id="paymentMethodSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    <option>Dinheiro</option>
                    <option>Cartão de Crédito/Débito</option>
                    <option>Pix</option>
                </select>
            </div>
            <div id="troco-input-container" class="hidden mb-4">
                <label for="trocoPara" class="block text-sm font-medium text-gray-700">Troco para (R$)</label>
                <input type="number" id="trocoPara" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            <div class="flex justify-end space-x-2">
                <button id="cancel-finalize-btn" class="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                <button id="confirm-finalize-btn" class="px-4 py-2 bg-green-600 text-white rounded-md">Confirmar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBJ44RVDGhBIlQBTx-pyIUp47XDKzRXk84",
            authDomain: "pizzaria-pdv.firebaseapp.com",
            projectId: "pizzaria-pdv",
            storageBucket: "pizzaria-pdv.appspot.com",
            messagingSenderId: "304171744691",
            appId: "1:304171744691:web:e54d7f9fe55c7a75485fc6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.body.style.visibility = 'visible';
            } else {
                window.location.href = `login.html?redirect=atendente.html`;
            }
        });

        const logoutBtn = document.getElementById('logout-btn');
        logoutBtn.addEventListener('click', () => {
            signOut(auth).catch((error) => console.error("Erro ao fazer logout:", error));
        });

        let order = [];
        let allMenuData = [];

        async function loadMenuAndRender() {
            try {
                const loadingEl = document.getElementById('loading-state');
                loadingEl.classList.remove('hidden');

                const response = await fetch('/api/menu');
                if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);
                
                const data = await response.json();
                
                // CORREÇÃO: Carrega TODOS os itens, a disponibilidade será controlada pelo listener do Firestore
                allMenuData = data.cardapio;
                
                let orderedUniqueCategories = [];
                const seenCategories = new Set();
                allMenuData.forEach(item => {
                    if (!seenCategories.has(item.category)) {
                        seenCategories.add(item.category);
                        orderedUniqueCategories.push(item.category);
                    }
                });
                
                createCategoryButtons(orderedUniqueCategories);
                populateMenu(allMenuData, orderedUniqueCategories);
                
                listenToItemStatus();

                loadingEl.classList.add('hidden');

            } catch (error) {
                console.error('Erro ao carregar o cardápio:', error);
                const loadingEl = document.getElementById('loading-state');
                loadingEl.textContent = 'Erro ao carregar o cardápio. Tente recarregar a página.';
            }
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
        }

        function createCategoryButtons(categories) {
            const container = document.getElementById('category-buttons-container');
            container.innerHTML = '';
            categories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-btn px-4 py-2 rounded-full bg-gray-200 text-gray-800 whitespace-nowrap';
                button.textContent = capitalizeFirstLetter(category);
                button.dataset.targetId = `${category}-section`;
                button.addEventListener('click', () => {
                    document.getElementById(button.dataset.targetId).scrollIntoView({ behavior: 'smooth' });
                });
                container.appendChild(button);
            });
        }

        function populateMenu(menuItems, orderedCategories) {
            const dynamicSectionsContainer = document.getElementById('dynamic-pizza-sections');
            dynamicSectionsContainer.innerHTML = ''; 

            const itemsByCategory = {};
            menuItems.forEach(item => {
                if (!itemsByCategory[item.category]) {
                    itemsByCategory[item.category] = [];
                }
                itemsByCategory[item.category].push(item);
            });

            orderedCategories.forEach(category => {
                const sectionId = `${category}-section`;
                let sectionEl = document.getElementById(sectionId);

                if (!sectionEl) {
                    sectionEl = document.createElement('div');
                    sectionEl.id = sectionId;
                    sectionEl.className = 'pizza-category-section mb-8';
                    
                    const title = capitalizeFirstLetter(category);

                    sectionEl.innerHTML = `
                        <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">${title}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="${category}-items"></div>
                    `;
                    dynamicSectionsContainer.appendChild(sectionEl);
                }

                const categoryItemsEl = document.getElementById(`${category}-items`);
                categoryItemsEl.innerHTML = ''; 

                if (itemsByCategory[category]) {
                    itemsByCategory[category].forEach(item => {
                        const itemHtml = `
                            <div class="bg-white rounded-lg shadow p-3 flex flex-col justify-between" data-item-id-card="${item.id}">
                                <div>
                                    <h4 class="font-bold">${item.name}</h4>
                                    <p class="text-sm text-gray-600">${item.description}</p>
                                </div>
                                <div class="flex justify-between items-center mt-3">
                                    <span class="font-semibold">R$ ${item.basePrice.toFixed(2).replace('.', ',')}</span>
                                    <button class="add-item-btn bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600" data-item-id="${item.id}">Adicionar</button>
                                </div>
                            </div>
                        `;
                        categoryItemsEl.insertAdjacentHTML('beforeend', itemHtml);
                    });
                }
            });

            attachAddButtonListeners();
        }

        function attachAddButtonListeners() {
            document.querySelectorAll('.add-item-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.target.dataset.itemId;
                    const item = allMenuData.find(i => i.id === itemId);
                    if (item) {
                        addToOrder(item);
                    }
                });
            });
        }

        function addToOrder(item) {
            order.push({
                name: item.name,
                price: item.basePrice,
                type: 'full',
                description: item.description,
                category: item.category
            });
            updateOrderDisplay();
        }

        function updateOrderDisplay() {
            const orderItemsContainer = document.getElementById('orderItems');
            const emptyMsg = document.getElementById('emptyOrderMessage');
            const totalEl = document.getElementById('total');
            let total = 0;

            if (order.length === 0) {
                emptyMsg.classList.remove('hidden');
                orderItemsContainer.innerHTML = '';
                orderItemsContainer.appendChild(emptyMsg);
            } else {
                emptyMsg.classList.add('hidden');
                orderItemsContainer.innerHTML = '';
                order.forEach((item, index) => {
                    total += item.price;
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex justify-between items-center py-2 border-b';
                    itemEl.innerHTML = `
                        <div>
                            <p class="font-medium">${item.name}</p>
                            <p class="text-sm text-gray-500">R$ ${item.price.toFixed(2).replace('.', ',')}</p>
                        </div>
                        <button data-index="${index}" class="remove-item-btn text-red-500 hover:text-red-700">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    orderItemsContainer.appendChild(itemEl);
                });
            }
            totalEl.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }

        document.getElementById('orderItems').addEventListener('click', (e) => {
            if (e.target.closest('.remove-item-btn')) {
                const index = e.target.closest('.remove-item-btn').dataset.index;
                order.splice(index, 1);
                updateOrderDisplay();
            }
        });

        const finalizeModal = document.getElementById('finalize-order-modal');
        const finalizeBtn = document.getElementById('finalize-order-btn');
        const cancelFinalizeBtn = document.getElementById('cancel-finalize-btn');
        const confirmFinalizeBtn = document.getElementById('confirm-finalize-btn');
        const paymentMethodSelect = document.getElementById('paymentMethodSelect');
        const trocoContainer = document.getElementById('troco-input-container');

        finalizeBtn.addEventListener('click', () => {
            if (order.length > 0) {
                finalizeModal.style.display = 'flex';
            } else {
                alert('O pedido está vazio.');
            }
        });

        cancelFinalizeBtn.addEventListener('click', () => {
            finalizeModal.style.display = 'none';
        });

        paymentMethodSelect.addEventListener('change', () => {
            if (paymentMethodSelect.value === 'Dinheiro') {
                trocoContainer.classList.remove('hidden');
            } else {
                trocoContainer.classList.add('hidden');
            }
        });

        confirmFinalizeBtn.addEventListener('click', async () => {
            const clientName = document.getElementById('clientNameInput').value.trim();
            const contact = document.getElementById('contactInput').value.trim();
            if (!clientName) {
                alert('Por favor, insira o nome do cliente ou da mesa.');
                return;
            }

            let subtotal = order.reduce((acc, item) => acc + item.price, 0);
            
            let paymentMethod = paymentMethodSelect.value;
            if (paymentMethod === 'Dinheiro') {
                const trocoPara = parseFloat(document.getElementById('trocoPara').value);
                if (!isNaN(trocoPara) && trocoPara > 0) {
                    paymentMethod = {
                        method: 'Dinheiro',
                        trocoPara: trocoPara,
                        trocoTotal: trocoPara - subtotal
                    };
                }
            }

            const newOrder = {
                itens: order,
                endereco: {
                    clientName: clientName,
                    telefone: contact,
                    rua: 'Atendimento Interno',
                    numero: '',
                    bairro: '',
                    referencia: ''
                },
                total: {
                    subtotal: subtotal,
                    discount: 0,
                    deliveryFee: 0,
                    finalTotal: subtotal
                },
                pagamento: paymentMethod,
                status: 'Novo',
                criadoEm: serverTimestamp()
            };

            try {
                await addDoc(collection(db, "pedidos"), newOrder);
                alert('Pedido enviado com sucesso!');
                order = [];
                updateOrderDisplay();
                document.getElementById('clientNameInput').value = '';
                document.getElementById('contactInput').value = '';
                document.getElementById('trocoPara').value = '';
                trocoContainer.classList.add('hidden');
                finalizeModal.style.display = 'none';
            } catch (error) {
                console.error("Erro ao enviar pedido: ", error);
                alert('Falha ao enviar o pedido.');
            }
        });

        function listenToItemStatus() {
            const itemStatusRef = doc(db, "config", "item_status");
            onSnapshot(itemStatusRef, (doc) => {
                const unavailableItems = doc.exists() ? doc.data() : {};
                updateItemsAvailability(unavailableItems);
            });
        }

        function updateItemsAvailability(unavailableItems = {}) {
            allMenuData.forEach(item => {
                const card = document.querySelector(`[data-item-id-card="${item.id}"]`);
                if (card) {
                    const button = card.querySelector('.add-item-btn');
                    const isUnavailable = unavailableItems[item.id] === false;

                    if (isUnavailable) {
                        button.disabled = true;
                        button.textContent = 'Esgotado';
                        button.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                        button.classList.add('bg-gray-400', 'cursor-not-allowed');
                        card.classList.add('opacity-50');
                    } else {
                        button.disabled = false;
                        button.textContent = 'Adicionar';
                        button.classList.add('bg-blue-500', 'hover:bg-blue-600');
                        button.classList.remove('bg-gray-400', 'cursor-not-allowed');
                        card.classList.remove('opacity-50');
                    }
                }
            });
        }

        loadMenuAndRender();
    </script>
</body>
</html>
